% This script simulates a couple different methods for extrapolating the
% value on the display. I want to update it every 10ms or so, but I can
% probably only ping the server every minute or so. Below you can find 
% three different sets of real data from the server, for different sampling
% intervals and durations. 
%

%% Ts=10s for 100*10s=16m40s
dt_samples = 10;
samples = [31537744942583,31537747858935,31537747940855,31537748678135,31537749906935,31537751430647,31537752200695,31537753626103,31537753691639,31537754248695,31537755624951,31537756214775,31537756886519,31537758262775,31537758868983,31537760261623,31537760916983,31537761621495,31537762227703,31537762850295,31537764914679,31537765553655,31537766274551,31537767798263,31537768633847,31537770370551,31537774351863,31537776842231,31537777972727,31537778611703,31537778791927,31537780446711,31537781200375,31537783084535,31537785886199,31537791391223,31537792587255,31537794487799,31537794586103,31537795061239,31537796322807,31537798141431,31537799943671,31537800041975,31537800762871,31537802073591,31537802761719,31537803482615,31537804776951,31537805497847,31537806841335,31537808758263,31537809446391,31537810953719,31537811887607,31537812510199,31537813837303,31537814590967,31537815279095,31537816606199,31537816753655,31537817261559,31537817834999,31537818965495,31537819653623,31537820243447,31537821488631,31537822225911,31537822930423,31537823536631,31537824945655,31537825617399,31537826780663,31537826944503,31537828091383,31537828189687,31537828812279,31537829926391,31537831499255,31537832285687,31537832433143,31537833547255,31537834661367,31537835349495,31537835415031,31537836447223,31537836479991,31537837086199,31537839920631,31537842001399,31537843836407,31537844704759,31537846359543,31537847162359,31537847997943,31537848751607,31537850045943,31537850193399,31537850799607,31537852732919];

%% Ts=60s for 100*60s=1h40m
dt_samples = 60;
samples = [31538243343863,31538263299575,31538275931639,31538287826423,31538307126775,31538317202935,31538327524855,31538337207799,31538340271607,31538342811127,31538345055735,31538353296887,31538365421047,31538375136759,31538381592055,31538394912247,31538405004791,31538420749815,31538421994999,31538424616439,31538427631095,31538429318647,31538433463799,31538446308855,31538461398519,31538475292151,31538487530999,31538502276599,31538510271991,31538515711479,31538524034551,31538530473463,31538539304439,31538552706551,31538558916087,31538575529463,31538584835575,31538598893047,31538604758519,31538608936439,31538615997943,31538624075255,31538637493751,31538647160311,31538655139319,31538661971447,31538674947575,31538684630519,31538690463223,31538702030327,31538711926263,31538722035191,31538731193847,31538747610615,31538781820407,31538794763767,31538808526327,31538817209847,31538830202359,31538856302071,31538866017783,31538870228471,31538874193399,31538877158903,31538880796151,31538882811383,31538898753015,31538907878903,31538921297399,31538930636279,31538942940663,31538951181815,31538970433015,31538977068535,31538982426103,31538988881399,31538995451383,31539000071671,31539011868151,31539018814967,31539026269687,31539038754295,31539045340663,31539052942839,31539060725239,31539068261879,31539077453303,31539081467383,31539089217015,31539100374519,31539112908279,31539121526263,31539127522807,31539136992759,31539142907383,31539148248567,31539165173239,31539181098487,31539195500023,31539212080631];

%% Ts=5m for 100*5m=8h20m
dt_samples = 300;
samples = [31539813914103,31539864884727,31539911759351,31539945084407,31539980342775,31540014093815,31540053317111,31540085364215,31540113757687,31540141364727,31540174345719,31540214961655,31540264785399,31540301682167,31540355077623,31540394169847,31540432311799,31540480775671,31540500125175,31540538086903,31540562187767,31540605916663,31540626167287,31540658787831,31540758681079,31540826002935,31540858525175,31540886099447,31540933563895,31540987778551,31541089113591,31541169051127,31541226903031,31541285344759,31541318850039,31541347751415,31541378160119,31541420004855,31541469009399,31541542426103,31541597427191,31541677889015,31541729056247,31541783565815,31541832586743,31541924271607,31541977339383,31542118176247,31542156563959,31542299858423,31542380713463,31542483391991,31542608762359,31542750139895,31542865876471,31542987101687,31543082472951,31543246001655,31543398897143,31543515190775,31543621981687,31543710553591,31543783986679,31543784936951,31543786493431,31543787623927,31543788901879,31543790949879,31543792473591,31543794144759,31543795897847,31543796864503,31543798781431,31543800223223,31543801288183,31543802861047,31543804368375,31543805482487,31543806957047,31543808398839,31543810004471,31543811708407,31543812691447,31543814493687,31543816001015,31543817606647,31543818950135,31543820277239,31543833236983,31543882208759,31543945516535,31544009364983,31544112453111,31544268822007,31544437331447,31544663184887,31544988816887,31545226335735,31545403643383,31545591551479];

%%
dt_update = dt_samples/100;
N = size(samples,2);

t_samples = 0:dt_samples:(size(samples,2)-1)*dt_samples;
t_interpo = 0:dt_update:(size(samples,2)-1)*dt_samples;

interpo1 = zeros(size(t_interpo));
interpo2 = zeros(size(t_interpo));
interpo3 = zeros(size(t_interpo));
interpo4 = zeros(size(t_interpo));
interpo5 = zeros(size(t_interpo));

cur_sample = 1;
proportional = samples(1);
prevProj = samples(1); interpo4(1) = samples(1);
prevProj2 = samples(1); interpo5(1) = samples(1);
for i=1:size(t_interpo,2)
   if (t_interpo(i) >= t_samples(cur_sample+1))
       prevProj = interpo4(max(1,i-1));
       prevProj2 = interpo5(max(1,i-1));
       cur_sample = cur_sample + 1;
   end
   
   % just use last sample
   interpo1(i) = samples(cur_sample);
   
   % proportional average (i think an LP rc circuit)
%    a = 0.01;
%    proportional = (1-a)*proportional + a*samples(cur_sample);
   shift = 2^8;
   proportional = proportional - (proportional - samples(cur_sample))/shift;
   interpo2(i) = proportional;
   
   % perfect 10 second delay
   mDelay = (samples(cur_sample) - samples(max(cur_sample-1,1))) / (1*dt_samples);
   mDelay = max(0, mDelay); % Ignore slope of zero (can't decrease)
   bDelay = samples(cur_sample) - mDelay*t_samples(max(min(cur_sample+1,N),1));
   interpo3(i) = mDelay*t_interpo(i)+bDelay;
   
   % n point projection monotonic
   % Here we compare now to 'n' points ago to project what next sample will
   % be. These are the m2, b2 and projected values.
   % First we project what the next sample will be.
   n = 2;
   mNext = (samples(cur_sample) - samples(max(cur_sample-n,1))) / (n*dt_samples);
   mNext = max(0, mNext); % Ignore slope of zero (can't decrease)
   mNext = mNext * 0.5;
   bNext = samples(cur_sample) - mNext*t_samples(cur_sample);
   yNext = mNext*t_samples(min(cur_sample+1,N))+bNext;
   
   % Then we increment linearly from current value to the next projected sample.
   mProj = (yNext - prevProj) / dt_samples;
   mProj = max(0, mProj);
   bProj = prevProj - mProj*t_samples(cur_sample);
   projected = mProj*t_interpo(i)+bProj;
   interpo4(i) = projected;
   
   % parabolic projection (same as above but use a parabola for first projection instead)
   x1 = t_samples(max(cur_sample-2,1));
   x2 = t_samples(max(cur_sample-1,1));
   x3 = t_samples(max(cur_sample-0,1));
   y1 =   samples(max(cur_sample-2,1));
   y2 =   samples(max(cur_sample-1,1));
   y3 =   samples(max(cur_sample-0,1));
   
   c  = (y1-y2) / (y2-y3);
   x0 = ( -x1^2 + x2^2 + c*( x2^2 - x3^2 ) )  /  (2.0*( -x1+x2 + c*x2 - c*x3 ));
   a  = (y1-y2)  /  ( (x1-x0)^2 - (x2-x0)^2 );
   y0 = y1 - a*(x1-x0)^2;
   
   yNext = a*(t_samples(min(cur_sample+1,N))-x0)^2 + y0;
   
   mProj = (yNext - prevProj2) / dt_samples;
   mProj = max(0, mProj);
   bProj = prevProj2 - mProj*t_samples(cur_sample);
   projected = mProj*t_interpo(i)+bProj;
   interpo5(i) = projected;
   
end

t_interpo = t_interpo / 60;
t_samples = t_samples / 60;

figure, plot(t_samples, samples,'-o');
hold on
plot(t_interpo, interpo1, '--', 'visible','off')
plot(t_interpo, interpo2, '--')
plot(t_interpo, interpo3, '--')
plot(t_interpo, interpo4, '--')
plot(t_interpo, interpo5, '--')

legend("Samples", "Last", "RC", "Delay", "Projection", "Parabola", 'Location','northwest');
xlabel("Time (minutes)"), ylabel("Bytes");
% set(gcf,'Position',[100 100 1500 1200])